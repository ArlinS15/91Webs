<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>91page</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <h1 onclick="bukaLogPribadi()" style="cursor:pointer; color: #00d2ff;">
    9Â¹
  </h1>
  
  <p>Testing To lol</p>

  <script>
    // 1. KONFIGURASI FIREBASE (PASTIKAN TETAP SEPERTI INI)
    const firebaseConfig = {
        apiKey: "AIzaSyDlucMVwMUbw7Ab3t2AVzI13EOHUrqDNZw",
        authDomain: "web-kelas-5b83a.firebaseapp.com",
        databaseURL: "https://web-kelas-5b83a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "web-kelas-5b83a",
        storageBucket: "web-kelas-5b83a.firebasestorage.app",
        messagingSenderId: "711947014423",
        appId: "1:711947014423:web:d8cb787c503d7d7538e752",
        measurementId: "G-RYNNLZCGY5"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. LOGIKA LAPOR DIRI (Heartbeat 5 Detik & Anti-Login Ganda)
    const userAktif = localStorage.getItem('savedUser');
    const mySessionID = localStorage.getItem('sessionID'); // Ambil kunci sesi dari login

    if (!userAktif || userAktif === "undefined") {
        alert("Sesi habis, silakan login ulang!");
        window.location.href = "index.html"; 
    } else {
        const userLogRef = database.ref('log_online/' + userAktif);

        // CEK LOGIN GANDA: Jika sessionID di server beda dengan di HP ini, tendang!
        userLogRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.sessionID && data.sessionID !== mySessionID) {
                alert("Akun ini telah login di perangkat lain!");
                localStorage.clear();
                window.location.href = "index.html";
            }
        });

        function kirimSinyalAktif() {
            const waktu = new Date().toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            userLogRef.update({
                username: userAktif, 
                jam: waktu,
                sessionID: mySessionID, // Kirim ID sesi biar gak dikira login baru
                last_seen: firebase.database.ServerValue.TIMESTAMP,
                status: "Aktif di Page 91"
            }).catch(err => console.error("Gagal lapor:", err));
        }

        kirimSinyalAktif();
        userLogRef.onDisconnect().remove();
        setInterval(kirimSinyalAktif, 5000);

        // FITUR BAN REALTIME
        database.ref('status_user/' + userAktif).on('value', (snapshot) => {
            if (snapshot.exists() && snapshot.val() === "banned") {
                alert("Akses Anda telah dicabut!");
                localStorage.clear();
                window.location.href = "index.html";
            }
        });
    }

    // 3. FUNGSI RIWAYAT PRIBADI
    window.bukaLogPribadi = function() {
        if (!userAktif) return alert("Login dulu!");
        database.ref('riwayat_pribadi/' + userAktif).limitToLast(5).once('value', (snapshot) => {
            let text = `ðŸ“œ Riwayat Login (${userAktif}):\n\n`;
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    text += `â€¢ ${child.val().waktu}\n`;
                });
                alert(text);
            } else {
                alert("Belum ada riwayat.");
            }
        });
    };
  </script>
</body>
</html>
